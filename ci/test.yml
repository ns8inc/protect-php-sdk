---
platform: linux

image_resource:
  type: registry-image
  source: { repository: php, tag: cli }

inputs:
  - name: protect-php-sdk

run:
  path: /bin/sh
  args:
    - -c
    - |
      apt-get update
      apt-get install -y git unzip wget
      pecl install xdebug
      docker-php-ext-enable xdebug

      EXPECTED_SIGNATURE="$(wget -q -O - https://composer.github.io/installer.sig)"
      php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
      ACTUAL_SIGNATURE="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"

      if [ "$EXPECTED_SIGNATURE" != "$ACTUAL_SIGNATURE" ]; then
        >&2 echo 'ERROR: Invalid installer signature'
        rm -f composer-setup.php
        exit 1
      fi

      php composer-setup.php --filename=composer --install-dir=/usr/local/bin --quiet

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: Composer setup failed'
        exit 1
      fi

      cd protect-php-sdk
      composer install -q

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: Composer install failed'
        exit 1
      fi

      composer lint

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: Lint check failed'
        exit 1
      fi

      composer test-coverage

      if [ $? -ne 0 ]; then
        >&2 echo 'ERROR: Tests failed'
        exit 1
      fi
